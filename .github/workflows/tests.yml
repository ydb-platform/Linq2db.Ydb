name: tests

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  ydb-tests:
    runs-on: ubuntu-22.04
    env:
      YDB_HOST: localhost
      YDB_PORT: 2136
      YDB_DB: /local
      YDB_USE_TLS: "false"
      YDB_TLS_PORT: 2135

    services:
      ydb:
        image: ydbplatform/local-ydb:latest
        ports:
          - 2135:2135
          - 2136:2136
          - 8765:8765
        env:
          YDB_LOCAL_SURVIVE_RESTART: true
        options: --name ydb-local -h localhost

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Wait for YDB
        shell: bash
        run: |
          for i in {1..60}; do
            if curl -sk https://localhost:8765/ > /dev/null; then
              break
            fi
            sleep 2
          done

      - name: Run tests
        run: dotnet test --logger "GitHubActions;report-warnings=false"
